---
layout: post
title: sadas
category: 技术
---
<script type="text/javascript">
	var IMAGE_DEFAULT = "../public/img/mona_lisa_crop.jpg";
	var IMAGE = new Image();

	var ID_EVOLVE = 0;

	var WIDTH = 0;
	var HEIGHT = 0;
	var CANVAS_SOURCE = 0;
	var CANVAS_EVOLVE = 0;
	var CONTEXT_SOURCE = 0;
	var CONTEXT_EVOLVE = 0;
	var DATA_SOURCE = 0;
	var DATA_EVOLVE = 0;

	var MAX_POLYGONS = 50;
	var MAX_POINTS = 6;

	var INDIV_EVOLVE = new Array(MAX_POLYGONS);

	var CHANGED_POLYGON_INDEX = 0;
	var CHANGED_POINT_INDEX = 0;
	var CHANGED_POLYGON = 0;

	var SUBPIXELS = 0;
	var DEPTH = 4;

	var FITNESS_MAX = 999923400656;
	var FITNESS_SOURCE = FITNESS_MAX;
	var FITNESS_EVOLVE = FITNESS_MAX;

	function init() {
		IMAGE.src = IMAGE_DEFAULT;
		IMAGE.onload = function() {
			init_canvas();
			init_data();
			unitTest();
		}
	}
	window.onload = init();
	function random_int(maxval) {
		return Math.round(maxval * Math.random());
	}

	function random_float(maxval) {
		return maxval * Math.random();
	}

	

	function init_canvas() {
		CANVAS_SOURCE = document.getElementById('canvas_source');
		CONTEXT_SOURCE = CANVAS_SOURCE.getContext('2d');

		CANVAS_EVOLVE = document.getElementById('canvas_evolve');
		CONTEXT_EVOLVE = CANVAS_EVOLVE.getContext('2d');

		WIDTH = IMAGE.width;
		HEIGHT = IMAGE.height;

		CANVAS_SOURCE.setAttribute('width', WIDTH);
		CANVAS_SOURCE.setAttribute('height', HEIGHT);

		CANVAS_EVOLVE.setAttribute('width', WIDTH);
		CANVAS_EVOLVE.setAttribute('height', HEIGHT);

		SUBPIXELS = WIDTH * HEIGHT * DEPTH;

		CONTEXT_SOURCE.drawImage(IMAGE, 0, 0, WIDTH, HEIGHT)
	}

	function init_data() {
		DATA_SOURCE = CONTEXT_SOURCE.getImageData(0, 0, WIDTH, HEIGHT).data;

		for (var i = 0; i < MAX_POLYGONS; i++) {
			var color = {
				'r': random_int(255),
				'g': random_int(255),
				'b': random_int(255),
				'a': 0.001
			};
			var points = new Array(MAX_POINTS);
			for (var j = 0; j < MAX_POINTS; j++) {
				points[j] = {
					'x': random_int(WIDTH),
					'y': random_int(HEIGHT)
				};
			}
			var polygon = {
				'color': color,
				'points': points
			}
			INDIV_EVOLVE[i] = polygon;
		};
		//init CHANGED_POLYGON
		var color = {
			'r': random_int(255),
			'g': random_int(255),
			'b': random_int(255),
			'a': 0.001
		};
		var points = new Array(MAX_POINTS);
		for (var j = 0; j < MAX_POINTS; j++) {
			points[j] = {
				'x': random_int(WIDTH),
				'y': random_int(HEIGHT)
			};
		}
		CHANGED_POLYGON = {
			'color': color,
			'points': points
		}
	}

	function start() {
		ID_EVOLVE = setInterval(evolve, 0);
	}

	function stop() {
		clearInterval(ID_EVOLVE);
	}

	function evolve() {
		mutate();
		draw(CONTEXT_EVOLVE, INDIV_EVOLVE);
		FITNESS_EVOLVE = compute_fitness();
		console.log(FITNESS_EVOLVE + " " + FITNESS_SOURCE);

		if (FITNESS_EVOLVE < FITNESS_SOURCE) {
			FITNESS_SOURCE = FITNESS_EVOLVE;
		} else {
			//roll back
			copyPolugon(CHANGED_POLYGON, INDIV_EVOLVE[CHANGED_POLYGON_INDEX]);
		}


	}

	function mutate() {
		CHANGED_POLYGON_INDEX = random_int(MAX_POLYGONS - 1);
		copyPolugon(INDIV_EVOLVE[CHANGED_POLYGON_INDEX], CHANGED_POLYGON);
		var ran = random_float(2.0);
		if (ran < 1) {
			if (ran < 0.25) {
				INDIV_EVOLVE[CHANGED_POLYGON_INDEX].color.r = random_int(255);
			} else if (ran < 0.5) {
				INDIV_EVOLVE[CHANGED_POLYGON_INDEX].color.g = random_int(255);
			} else if (ran < 0.75) {
				INDIV_EVOLVE[CHANGED_POLYGON_INDEX].color.b = random_int(255);
			} else {
				INDIV_EVOLVE[CHANGED_POLYGON_INDEX].color.a = random_float(1.0);
			}
		} else {
			CHANGED_POINT_INDEX = random_int(MAX_POINTS - 1);
			if (ran < 1.5) {
				INDIV_EVOLVE[CHANGED_POLYGON_INDEX].points[CHANGED_POINT_INDEX].x = random_int(WIDTH);
			} else {
				INDIV_EVOLVE[CHANGED_POLYGON_INDEX].points[CHANGED_POINT_INDEX].y = random_int(HEIGHT);
			}

		}
	}

	function copyPolugon(from, to) {
		to.color.r = from.color.r;
		to.color.g = from.color.g;
		to.color.b = from.color.b;
		to.color.a = from.color.a;

		for (var j = 0; j < MAX_POINTS; j++) {
			to.points[j].x = from.points[j].x;
			to.points[j].y = from.points[j].y;
		};
	}

	function compute_fitness() {
		var fitness = 0;

		DATA_EVOLVE = CONTEXT_EVOLVE.getImageData(0, 0, WIDTH, HEIGHT).data;

		for (var i = 0; i < SUBPIXELS; ++i) {
			if (i % DEPTH != 3)
				fitness += Math.abs(DATA_SOURCE[i] - DATA_EVOLVE[i]);
		}
		return fitness;
	}

	function draw(ctx, polygons) {
		ctx.fillStyle = "rgb(255,255,255)";
		ctx.fillRect(0, 0, WIDTH, HEIGHT);
		for (var i = 0; i < MAX_POLYGONS; i++) {
			drawPolygon(ctx, polygons[i]);
		};
	}

	function drawPolygon(ctx, polygon) {
		ctx.fillStyle = "rgba(" + polygon.color.r + "," + polygon.color.g + "," + polygon.color.b + "," + polygon.color.a + ")";
		ctx.beginPath();
		ctx.moveTo(polygon.points[0].x, polygon.points[0].y);
		for (var i = 1; i < MAX_POINTS; i++) {
			ctx.lineTo(polygon.points[i].x, polygon.points[i].y);
		}
		ctx.closePath();
		ctx.fill();
	}
</script>

<div>
	<canvas id="canvas_source" width=200 height=200></canvas>
	<canvas id="canvas_evolve" width=200 height=200></canvas>
	<input type="button" value="Start" onclick="start()" />
	<input type="button" value="Stop" onclick="stop()" />
<div>